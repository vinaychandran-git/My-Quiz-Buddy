<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Quiz Buddy</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#039be5">
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
        navigator.serviceWorker.register('./service-worker.js')
        .then(reg => console.log('Service worker registered:', reg))
        .catch(err => console.log('Service worker error:', err));
        });
    }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; min-height: 100vh; padding: 20px; line-height: 1.6; color: #2c3e50; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; }
        .app-header { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); padding: 24px 32px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #34495e; }
        h1 { color: white; font-size: 1.75em; font-weight: 600; }
        h2 { color: #2c3e50; font-size: 1.5em; margin-bottom: 20px; font-weight: 600; }
        h3 { color: #34495e; font-size: 1.2em; margin-bottom: 15px; font-weight: 600; }
        .tabs { display: flex; border-bottom: 2px solid #ecf0f1; background: #fafbfc; }
        .tab-button { padding: 16px 28px; font-size: 0.95em; border: none; background: transparent; color: #7f8c8d; cursor: pointer; transition: all 0.2s; font-weight: 600; border-bottom: 3px solid transparent; margin-bottom: -2px; flex: 1; text-align: center; }
        .tab-button.active { color: #2c3e50; border-bottom-color: #5a7ab8; background: white; }
        .tab-button:hover { color: #34495e; background: #f8f9fa; }
        .tab-content { display: none; animation: fadeIn 0.3s; padding: 32px; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .collapsible-section { background: #fafbfc; border-radius: 6px; margin-bottom: 24px; overflow: hidden; border: 1px solid #e1e8ed; }
        .collapsible-header { background: #f8f9fa; color: #2c3e50; padding: 14px 20px; cursor: pointer; display: flex; justify-content: space-between; font-weight: 600; transition: all 0.2s; border-bottom: 1px solid #e1e8ed; }
        .collapsible-header:hover { background: #ecf0f1; }
        .collapsible-content { padding: 20px; display: none; background: white; }
        .collapsible-content.active { display: block; }
        .collapse-icon { transition: transform 0.3s; font-size: 1.1em; color: #7f8c8d; }
        .collapse-icon.rotated { transform: rotate(180deg); }
        .filter-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }
        .filter-group { display: flex; flex-direction: column; }
        input[type="file"] { display: none; }
        .question-card { background: white; padding: 20px; border-radius: 6px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border: 1px solid #e1e8ed; transition: all 0.2s; }
        .question-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.12); border-color: #cbd5e0; }
        .question-card-header { font-size: 1.05em; font-weight: 600; color: #2c3e50; margin-bottom: 14px; }
        .question-card-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 14px 0; font-size: 0.95em; }
        .question-card-option { padding: 10px 14px; background: #f8f9fa; border-radius: 4px; border: 1px solid #e1e8ed; }
        .question-card-meta { display: flex; flex-wrap: wrap; gap: 8px; margin: 14px 0; font-size: 0.85em; }
        .meta-badge { padding: 5px 12px; border-radius: 4px; font-weight: 600; background: #f8f9fa; color: #34495e; border: 1px solid #e1e8ed; }
        .meta-badge.correct { background: #e8f5e9; color: #2e7d32; border-color: #a5d6a7; }
        .meta-badge.subject { background: #e3f2fd; color: #1565c0; border-color: #90caf9; }
        .meta-badge.difficulty.easy { background: #e8f5e9; color: #2e7d32; border-color: #a5d6a7; }
        .meta-badge.difficulty.medium { background: #fff3e0; color: #e65100; border-color: #ffcc80; }
        .meta-badge.difficulty.hard { background: #ffebee; color: #c62828; border-color: #ef9a9a; }
        .meta-badge.tags { background: #f3e5f5; color: #6a1b9a; border-color: #ce93d8; }
        .question-card-actions { display: flex; gap: 8px; margin-top: 14px; padding-top: 14px; border-top: 1px solid #e1e8ed; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95em; font-weight: 600; transition: all 0.2s; margin: 5px; display: inline-flex; align-items: center; gap: 8px; font-family: inherit; }
        .btn-primary { background: #5a7ab8; color: white; }
        .btn-primary:hover { background: #4a6aa8; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(90, 122, 184, 0.3); }
        .btn-success { background: #52c77c; color: white; }
        .btn-success:hover { background: #42b76c; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(82, 199, 124, 0.3); }
        .btn-danger { background: #ee7065; color: white; }
        .btn-danger:hover { background: #de6055; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(238, 112, 101, 0.3); }
        .btn-warning { background: #f5a648; color: white; }
        .btn-warning:hover { background: #e59638; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(245, 166, 72, 0.3); }
        .btn-info { background: #5dade2; color: white; }
        .btn-info:hover { background: #4d9dd2; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(93, 173, 226, 0.3); }
        .unsaved-badge { display: inline-block; background: #e74c3c; color: white; padding: 6px 14px; border-radius: 4px; font-size: 0.85em; margin-left: 10px; font-weight: 600; }
        .quiz-settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .setting-card { background: white; padding: 20px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border: 1px solid #e1e8ed; transition: all 0.2s; }
        .setting-card h4 { color: #233c86; margin-bottom: 12px; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; }
        .setting-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.12); border-color: #cbd5e0; }
        .setting-description { color: #7f8c8d; font-size: 0.85em; margin-top: 8px; }
        label { font-weight: 600; color: #34495e; margin-bottom: 8px; display: block; font-size: 0.9em; }
        select, input[type="number"], input[type="text"], textarea { width: 100%; padding: 10px 12px; border: 1px solid #d1d8dd; border-radius: 6px; font-size: 0.95em; transition: all 0.2s; background: white; font-family: inherit; color: #233c86; }
        select:focus, input:focus, textarea:focus { outline: none; border-color: #233c86; box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1); }
        select[multiple] { min-height: 100px; padding: 6px; }
        select[multiple] option { padding: 8px 10px; margin: 2px 0; border-radius: 4px; cursor: pointer; }
        select[multiple] option:hover { background: #f8f9fa; }
        select[multiple] option:checked { background: #5a7ab8; color: white; }
        .quiz-question { background: white; padding: 28px; border-radius: 6px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border: 1px solid #e1e8ed; }
        .question-number { background: #5a7ab8; color: white; padding: 6px 14px; border-radius: 4px; display: inline-block; margin-bottom: 16px; font-weight: 600; font-size: 0.9em; }
        .options { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-top: 20px; }
        .option-wrapper { position: relative; }
        .option-wrapper input[type="radio"] { position: absolute; opacity: 0; cursor: pointer; }
        .option-label { background: #fafbfc; padding: 16px; border-radius: 6px; cursor: pointer; transition: all 0.2s; border: 2px solid #e1e8ed; display: flex; align-items: center; gap: 12px; font-size: 1em; color: #34495e; }
        .option-label::before { content: ''; width: 18px; height: 18px; border: 2px solid #bdc3c7; border-radius: 50%; flex-shrink: 0; background: white; transition: all 0.2s; }
        .option-wrapper input[type="radio"]:checked + .option-label { background: #5a7ab8; color: white; border-color: #5a7ab8; font-weight: 600; }
        .option-wrapper input[type="radio"]:checked + .option-label::before { background: white; border-color: white; box-shadow: inset 0 0 0 4px #5a7ab8; }
        .option-label:hover { background: #f0f3f5; border-color: #bdc3c7; }
        .option-wrapper input[type="radio"]:checked + .option-label:hover { background: #4a6aa8; border-color: #4a6aa8; }
        .timer { position: fixed; top: 20px; right: 20px; background: white; padding: 12px 20px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); font-size: 1.1em; font-weight: 600; color: #2c3e50; z-index: 1000; display: flex; align-items: center; gap: 8px; border: 1px solid #e1e8ed; }
        .timer.warning { background: #fff3e0; color: #e65100; border-color: #ffcc80; }
        .timer.danger { background: #ffebee; color: #c62828; border-color: #ef9a9a; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
        .results-section { text-align: center; padding: 32px 40px; background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); border-radius: 6px; margin-bottom: 32px; color: white; }
        .performance-emoji { font-size: 5em; margin: 20px 0; animation: bounce 1s ease-in-out; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        .performance-message { font-size: 1.6em; margin: 16px 0; font-weight: 600; }
        .result-item { background: white; padding: 20px; border-radius: 6px; margin-bottom: 16px; text-align: left; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border: 1px solid #e1e8ed; }
        .result-item.correct { border-left: 4px solid #27ae60; background: #f8fdf9; }
        .result-item.incorrect { border-left: 4px solid #e74c3c; background: #fef9f9; }
        .correct-answer { color: #27ae60; font-weight: 600; background: #e8f5e9; padding: 4px 10px; border-radius: 4px; }
        .incorrect-answer { color: #e74c3c; font-weight: 600; background: #ffebee; padding: 4px 10px; border-radius: 4px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 32px; border-radius: 6px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 16px rgba(0,0,0,0.2); }
        .form-group { margin-bottom: 20px; }
        textarea { resize: vertical; min-height: 80px; }
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin: 20px 0; justify-content: flex-start; align-items: center; }
        .action-buttons .btn { flex: 0 1 auto; min-width: 140px; }
        @media (max-width: 768px) {
            .action-buttons { flex-direction: column; align-items: stretch; }
            .action-buttons .btn { width: 100%; min-width: auto; }
        }
        .quiz-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin: 28px 0; }
        .stat-card { background: rgba(255,255,255,0.15); padding: 20px; border-radius: 6px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .stat-value { font-size: 2.2em; font-weight: 700; margin-bottom: 5px; }
        .stat-label { font-size: 0.95em; opacity: 0.95; }
        .start-quiz-btn { width: 100%; padding: 16px; font-size: 1.1em; background: #5a7ab8; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 24px; }
        .start-quiz-btn:hover { background: #4a6aa8; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(90, 122, 184, 0.3); }
        .repo-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e1e8ed; }
        .repo-modal-header h2 { margin: 0; color: #2c3e50; }
        .close-modal { font-size: 28px; font-weight: bold; color: #7f8c8d; cursor: pointer; transition: color 0.2s; }
        .close-modal:hover { color: #2c3e50; }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #5a7ab8; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .repo-status { padding: 15px; border-radius: 6px; margin-bottom: 20px; }
        .repo-status.loading { background: #e3f2fd; color: #1565c0; }
        .repo-status.success { background: #e8f5e9; color: #2e7d32; }
        .repo-status.error { background: #ffebee; color: #c62828; }
        .repo-file-item { padding: 12px; background: #f8f9fa; border-radius: 6px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .repo-file-item:hover { background: #e8f4f8; border-color: #3498db; }
        .repo-file-item.selected { background: #e8f4f8; border-color: #233c86; font-weight: 600; }
        .file-icon { font-size: 1.5em; }
        .file-info { flex: 1; }
        .file-name { font-weight: 600; color: #233c86; margin-bottom: 2px; }
        .file-size { font-size: 0.85em; color: #7f8c8d; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 2px solid #e1e8ed; }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .options { grid-template-columns: 1fr; }
            .quiz-settings-grid { grid-template-columns: 1fr; }
            h1 { font-size: 1.4em; }
            .app-header { padding: 18px 20px; }
            .timer { top: 10px; right: 10px; padding: 8px 14px; font-size: 0.95em; }
            .tab-button { padding: 12px 10px; font-size: 0.85em; }
            .tab-content { padding: 20px; }
            .performance-emoji { font-size: 3.5em; }
            .performance-message { font-size: 1.2em; }
            .filter-controls { grid-template-columns: 1fr; }
            .question-card-options { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-header">
            <h1>üìö My Quiz Buddy</h1>
        </div>
        
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('manage')">Manage Quiz Bank</button>
            <button class="tab-button" onclick="switchTab('quiz')">Take Quiz</button>
            <button class="tab-button" onclick="switchTab('results')">Results</button>
        </div>

        <div id="manage-tab" class="tab-content active">
            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleCollapsible('filters')">
                    <span>Filters</span>
                    <span class="collapse-icon" id="filters-icon">‚ñº</span>
                </div>
                <div class="collapsible-content" id="filters-content">
                    <div class="filter-controls">
                        <div class="filter-group">
                            <label for="bank-subject-filter">Filter by Subject</label>
                            <select id="bank-subject-filter" onchange="filterQuizBank()">
                                <option value="all">All Subjects</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="bank-level-filter">Filter by Level</label>
                            <select id="bank-level-filter" onchange="filterQuizBank()">
                                <option value="all">All Levels</option>
                                <option value="Easy">Easy</option>
                                <option value="Medium">Medium</option>
                                <option value="Hard">Hard</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="bank-tag-filter">Filter by Tag</label>
                            <select id="bank-tag-filter" onchange="filterQuizBank()">
                                <option value="all">All Tags</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="bank-search">Search Questions</label>
                            <input type="text" id="bank-search" placeholder="Type to search..." oninput="filterQuizBank()">
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="showAddQuestionModal()">Add New Question</button>
                <button class="btn btn-success" onclick="downloadQuizBank()">Download Quiz Bank</button>
                <button class="btn btn-warning" onclick="loadSampleData()">Load Sample Data</button>
                <label class="btn btn-primary" style="cursor: pointer;">
                    <input type="file" id="excel-file" accept=".xlsx,.xls" onchange="handleFileUpload(event)">
                    Upload Quiz Bank
                </label>
                <button class="btn btn-info" onclick="openRepoModal()">Load from Repository</button>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="color: #34495e; font-size: 1.2em; margin: 0;">Questions <span id="question-count-display" style="color: #7f8c8d; font-size: 0.9em;">(0 / 0)</span></h3>
                <span id="unsaved-indicator" style="display: none;" class="unsaved-badge">Unsaved Changes</span>
            </div>

            <div id="quiz-bank-container"></div>
        </div>

        <div id="quiz-tab" class="tab-content">
            <button class="start-quiz-btn" onclick="startQuiz()">Start Quiz</button>
            
            <h2>Configure Your Quiz</h2>
            
            <div id="total-questions-info" style="background: #e8f4f8; padding: 16px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #5a7ab8;">
                <p style="margin: 0; color: #2c3e50; font-weight: 600;">Available Questions: <span id="total-questions-count">0 / 0</span></p>
            </div>
            
            <div class="quiz-settings-grid">
                <div class="setting-card">
                    <h4>Subject Selection</h4>
                    <select id="subject-select" multiple onchange="updateAvailableQuestionsCount()">
                        <option value="all" selected>All Subjects</option>
                    </select>
                    <p class="setting-description">Hold Ctrl/Cmd to select multiple subjects</p>
                </div>
                
                <div class="setting-card">
                    <h4>Difficulty Level</h4>
                    <select id="level-select" multiple onchange="updateAvailableQuestionsCount()">
                        <option value="all" selected>All Levels</option>
                        <option value="Easy">Easy</option>
                        <option value="Medium">Medium</option>
                        <option value="Hard">Hard</option>
                    </select>
                    <p class="setting-description">Select one or more difficulty levels</p>
                </div>
                
                <div class="setting-card">
                    <h4>Tags Filter</h4>
                    <select id="tag-select" multiple onchange="updateAvailableQuestionsCount()">
                        <option value="all" selected>All Tags</option>
                    </select>
                    <p class="setting-description">Optional: Filter by specific tags</p>
                </div>
                
                <div class="setting-card">
                    <h4>Number of Questions</h4>
                    <input type="number" id="question-count" value="10" min="1">
                    <p class="setting-description">Maximum available will be selected if exceeded</p>
                </div>
                
                <div class="setting-card">
                    <h4>Time Limit (minutes)</h4>
                    <input type="number" id="time-limit" value="10" min="0">
                    <p class="setting-description">Set to 0 for no time limit</p>
                </div>
                
                <div class="setting-card">
                    <h4>Quiz Mode</h4>
                    <select id="quiz-mode">
                        <option value="all">All Questions at Once</option>
                        <option value="one">One Question at a Time</option>
                    </select>
                    <p class="setting-description">Choose display preference</p>
                </div>
            </div>
            
            <div id="quiz-container" style="display: none;">
                <div id="timer" class="timer" style="display: none;">‚è±Ô∏è 10:00</div>
                <div id="quiz-questions"></div>
                <button class="btn btn-success" onclick="submitQuiz()" style="width: 100%; margin-top: 20px;">Submit Quiz</button>
            </div>
        </div>

        <div id="results-tab" class="tab-content">
            <div id="results-container"></div>
        </div>
    </div>

    <div id="add-question-modal" class="modal">
        <div class="modal-content">
            <h2 style="color: #2c3e50; margin-bottom: 20px;">Add New Question</h2>
            <div class="form-group">
                <label for="new-subject">Subject *</label>
                <input type="text" id="new-subject" placeholder="e.g., Mathematics, Science">
            </div>
            <div class="form-group">
                <label for="new-difficulty">Difficulty *</label>
                <select id="new-difficulty">
                    <option value="">Select difficulty</option>
                    <option value="Easy">Easy</option>
                    <option value="Medium">Medium</option>
                    <option value="Hard">Hard</option>
                </select>
            </div>
            <div class="form-group">
                <label for="new-tags">Tags (comma-separated)</label>
                <input type="text" id="new-tags" placeholder="e.g., algebra, equations">
            </div>
            <div class="form-group">
                <label for="new-question">Question *</label>
                <textarea id="new-question" placeholder="Enter your question here..."></textarea>
            </div>
            <div class="form-group">
                <label for="new-option-a">Option A *</label>
                <input type="text" id="new-option-a" placeholder="First option">
            </div>
            <div class="form-group">
                <label for="new-option-b">Option B *</label>
                <input type="text" id="new-option-b" placeholder="Second option">
            </div>
            <div class="form-group">
                <label for="new-option-c">Option C *</label>
                <input type="text" id="new-option-c" placeholder="Third option">
            </div>
            <div class="form-group">
                <label for="new-option-d">Option D *</label>
                <input type="text" id="new-option-d" placeholder="Fourth option">
            </div>
            <div class="form-group">
                <label for="new-correct">Correct Answer *</label>
                <select id="new-correct">
                    <option value="">Select correct answer</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-danger" onclick="closeAddQuestionModal()">Cancel</button>
                <button class="btn btn-success" onclick="saveNewQuestion()">Save Question</button>
            </div>
        </div>
    </div>

    <div id="edit-question-modal" class="modal">
        <div class="modal-content">
            <h2 style="color: #2c3e50; margin-bottom: 20px;">Edit Question</h2>
            <input type="hidden" id="edit-index">
            <div class="form-group">
                <label for="edit-subject">Subject *</label>
                <input type="text" id="edit-subject">
            </div>
            <div class="form-group">
                <label for="edit-difficulty">Difficulty *</label>
                <select id="edit-difficulty">
                    <option value="Easy">Easy</option>
                    <option value="Medium">Medium</option>
                    <option value="Hard">Hard</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit-tags">Tags (comma-separated)</label>
                <input type="text" id="edit-tags">
            </div>
            <div class="form-group">
                <label for="edit-question">Question *</label>
                <textarea id="edit-question"></textarea>
            </div>
            <div class="form-group">
                <label for="edit-option-a">Option A *</label>
                <input type="text" id="edit-option-a">
            </div>
            <div class="form-group">
                <label for="edit-option-b">Option B *</label>
                <input type="text" id="edit-option-b">
            </div>
            <div class="form-group">
                <label for="edit-option-c">Option C *</label>
                <input type="text" id="edit-option-c">
            </div>
            <div class="form-group">
                <label for="edit-option-d">Option D *</label>
                <input type="text" id="edit-option-d">
            </div>
            <div class="form-group">
                <label for="edit-correct">Correct Answer *</label>
                <select id="edit-correct">
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-danger" onclick="closeEditQuestionModal()">Cancel</button>
                <button class="btn btn-success" onclick="saveEditedQuestion()">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="repo-modal" class="modal">
        <div class="modal-content">
            <div class="repo-modal-header">
                <h2>Load Quiz from Repository</h2>
                <span class="close-modal" onclick="closeRepoModal()">&times;</span>
            </div>
            <div id="repo-status"></div>
            <div id="repo-files-list"></div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeRepoModal()">Cancel</button>
                <button class="btn btn-success" id="load-repo-file-btn" onclick="loadSelectedRepoFile()" disabled>Load Selected File</button>
            </div>
        </div>
    </div>

    <script>
        // GitHub Configuration
        const GITHUB_CONFIG = {
            owner: "vinaychandran-git",
            repo: "My-Quiz-Buddy",
            branch: "main",
            folder: "quiz-banks"
        };

        let quizBank = [];
        let filteredBank = [];
        let currentQuiz = [];
        let userAnswers = {};
        let timerInterval = null;
        let unsavedChanges = false;
        let selectedRepoFile = null;
        let quizMode = 'all';
        let currentQuestionIndex = 0;

        function toggleCollapsible(id) {
            const content = document.getElementById(`${id}-content`);
            const icon = document.getElementById(`${id}-icon`);
            if(content.classList.contains('active')) {
                content.classList.remove('active');
                icon.classList.remove('rotated');
            } else {
                content.classList.add('active');
                icon.classList.add('rotated');
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            
            if(tab === 'manage') {
                document.getElementById('manage-tab').classList.add('active');
                document.querySelectorAll('.tab-button')[0].classList.add('active');
            } else if(tab === 'quiz') {
                document.getElementById('quiz-tab').classList.add('active');
                document.querySelectorAll('.tab-button')[1].classList.add('active');
                updateQuizFilters();
                
                // If quiz was previously taken, reset it
                if(currentQuiz.length > 0) {
                    currentQuiz = [];
                    userAnswers = {};
                    currentQuestionIndex = 0;
                    
                    if(timerInterval) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                    }
                    
                    document.getElementById('quiz-container').style.display = 'none';
                    document.getElementById('timer').style.display = 'none';
                    document.getElementById('timer').classList.remove('warning', 'danger');
                    document.getElementById('quiz-questions').innerHTML = '';
                    document.querySelector('.start-quiz-btn').style.display = 'block';
                    const quizHeader = document.querySelector('#quiz-tab h2');
                    if(quizHeader) quizHeader.style.display = 'block';
                    document.querySelector('.quiz-settings-grid').style.display = 'grid';
                    const totalQuestionsInfo = document.getElementById('total-questions-info');
                    if (totalQuestionsInfo) {
                        totalQuestionsInfo.style.display = 'block';
                    }
                    
                    // Reset filters to "All"
                    const subjectSelect = document.getElementById('subject-select');
                    Array.from(subjectSelect.options).forEach(option => {
                        option.selected = (option.value === 'all');
                    });
                    
                    const levelSelect = document.getElementById('level-select');
                    Array.from(levelSelect.options).forEach(option => {
                        option.selected = (option.value === 'all');
                    });
                    
                    const tagSelect = document.getElementById('tag-select');
                    Array.from(tagSelect.options).forEach(option => {
                        option.selected = (option.value === 'all');
                    });
                    
                    document.getElementById('question-count').value = 10;
                    document.getElementById('time-limit').value = 10;
                    document.getElementById('quiz-mode').value = 'all';
                    
                    if(quizBank.length > 0) {
                        updateAvailableQuestionsCount();
                    }
                }
            } else if(tab === 'results') {
                document.getElementById('results-tab').classList.add('active');
                document.querySelectorAll('.tab-button')[2].classList.add('active');
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if(jsonData.length === 0) {
                        alert('‚ùå No data found in the Excel file!');
                        return;
                    }
                    
                    // Get column names (handle case variations)
                    const firstRow = jsonData[0];
                    const getColumnValue = (row, possibleNames) => {
                        for(let name of possibleNames) {
                            if(row[name] !== undefined) return row[name];
                        }
                        return '';
                    };
                    
                    quizBank = jsonData.map(row => ({
                        subject: getColumnValue(row, ['Subject', 'subject', 'SUBJECT']) || '',
                        difficulty: getColumnValue(row, ['Difficulty', 'difficulty', 'DIFFICULTY', 'Level', 'level']) || 'Medium',
                        tags: (getColumnValue(row, ['Tags', 'tags', 'TAGS', 'Tag', 'tag']) || '').toString().split(',').map(t => t.trim()).filter(t => t),
                        question: getColumnValue(row, ['Question', 'question', 'QUESTION']) || '',
                        optionA: getColumnValue(row, ['OptionA', 'optionA', 'Option A', 'option A', 'OPTION A', 'A']) || '',
                        optionB: getColumnValue(row, ['OptionB', 'optionB', 'Option B', 'option B', 'OPTION B', 'B']) || '',
                        optionC: getColumnValue(row, ['OptionC', 'optionC', 'Option C', 'option C', 'OPTION C', 'C']) || '',
                        optionD: getColumnValue(row, ['OptionD', 'optionD', 'Option D', 'option D', 'OPTION D', 'D']) || '',
                        correct: getColumnValue(row, ['Correct', 'correct', 'CORRECT', 'Answer', 'answer', 'ANSWER', 'Correct Answer']) || ''
                    }));
                    
                    // Validate that we have questions with options
                    const validQuestions = quizBank.filter(q => 
                        q.question && q.optionA && q.optionB && q.optionC && q.optionD && q.correct
                    );
                    
                    if(validQuestions.length === 0) {
                        alert('‚ùå No valid questions found! Please ensure your Excel file has the correct column names:\nSubject, Difficulty, Tags, Question, OptionA, OptionB, OptionC, OptionD, Correct');
                        console.log('Sample row:', jsonData[0]);
                        return;
                    }
                    
                    if(validQuestions.length < quizBank.length) {
                        alert(`‚ö†Ô∏è Warning: ${quizBank.length - validQuestions.length} questions were skipped due to missing data.\nLoaded ${validQuestions.length} valid questions.`);
                    }
                    
                    quizBank = validQuestions;
                    
                    // Initialize filteredBank with all questions
                    filteredBank = [...quizBank];
                    
                    unsavedChanges = false;
                    updateUnsavedIndicator();
                    populateFilters();
                    filterQuizBank();
                    updateQuizFilters();
                    alert(`‚úÖ Successfully loaded ${quizBank.length} questions!`);
                } catch(error) {
                    alert('‚ùå Error reading file. Please ensure it\'s a valid Excel file with the correct format.');
                    console.error('Upload error:', error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function openRepoModal() {
            const modal = document.getElementById('repo-modal');
            const statusDiv = document.getElementById('repo-status');
            const filesDiv = document.getElementById('repo-files-list');
            
            modal.classList.add('active');
            statusDiv.innerHTML = '<div class="repo-status loading"><span class="loading-spinner"></span>Fetching quiz banks from repository...</div>';
            filesDiv.innerHTML = '';
            selectedRepoFile = null;
            document.getElementById('load-repo-file-btn').disabled = true;

            try {
                const files = await fetchRepoFiles();
                if (files.length === 0) {
                    statusDiv.innerHTML = '<div class="repo-status error">‚ö†Ô∏è No Excel files found in the quiz-banks folder.</div>';
                } else {
                    statusDiv.innerHTML = '<div class="repo-status success">‚úÖ Found ' + files.length + ' quiz bank(s) in repository</div>';
                    displayRepoFiles(files);
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="repo-status error">‚ùå Error loading files: ' + error.message + '</div>';
                console.error('Error fetching repo files:', error);
            }
        }

        function closeRepoModal() {
            document.getElementById('repo-modal').classList.remove('active');
            selectedRepoFile = null;
        }

        async function fetchRepoFiles() {
            const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.folder}?ref=${GITHUB_CONFIG.branch}`;
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error('Failed to fetch repository contents. Status: ' + response.status);
            }
            
            const data = await response.json();
            
            const excelFiles = data.filter(file => 
                file.type === 'file' && 
                (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls'))
            );
            
            return excelFiles;
        }

        function displayRepoFiles(files) {
            const filesDiv = document.getElementById('repo-files-list');
            filesDiv.innerHTML = '<h4 style="color: #233c86; margin-bottom: 12px;">üìÅ Available Quiz Banks:</h4>';
            
            files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'repo-file-item';
                fileItem.innerHTML = `
                    <span class="file-icon">üìä</span>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">Size: ${(file.size / 1024).toFixed(2)} KB</div>
                    </div>
                `;
                fileItem.onclick = () => selectRepoFile(file, fileItem);
                filesDiv.appendChild(fileItem);
            });
        }

        function selectRepoFile(file, element) {
            document.querySelectorAll('.repo-file-item').forEach(item => item.classList.remove('selected'));
            element.classList.add('selected');
            selectedRepoFile = file;
            document.getElementById('load-repo-file-btn').disabled = false;
        }

        async function loadSelectedRepoFile() {
            if (!selectedRepoFile) return;
            
            const statusDiv = document.getElementById('repo-status');
            const loadBtn = document.getElementById('load-repo-file-btn');
            
            loadBtn.disabled = true;
            statusDiv.innerHTML = '<div class="repo-status loading"><span class="loading-spinner"></span>Loading ' + selectedRepoFile.name + '...</div>';
            
            try {
                const response = await fetch(selectedRepoFile.download_url);
                if (!response.ok) {
                    throw new Error('Failed to download file');
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                if(jsonData.length === 0) {
                    throw new Error('No data found in the Excel file');
                }
                
                // Get column names (handle case variations)
                const getColumnValue = (row, possibleNames) => {
                    for(let name of possibleNames) {
                        if(row[name] !== undefined) return row[name];
                    }
                    return '';
                };
                
                quizBank = jsonData.map(row => ({
                    subject: getColumnValue(row, ['Subject', 'subject', 'SUBJECT']) || '',
                    difficulty: getColumnValue(row, ['Difficulty', 'difficulty', 'DIFFICULTY', 'Level', 'level']) || 'Medium',
                    tags: (getColumnValue(row, ['Tags', 'tags', 'TAGS', 'Tag', 'tag']) || '').toString().split(',').map(t => t.trim()).filter(t => t),
                    question: getColumnValue(row, ['Question', 'question', 'QUESTION']) || '',
                    optionA: getColumnValue(row, ['OptionA', 'optionA', 'Option A', 'option A', 'OPTION A', 'A']) || '',
                    optionB: getColumnValue(row, ['OptionB', 'optionB', 'Option B', 'option B', 'OPTION B', 'B']) || '',
                    optionC: getColumnValue(row, ['OptionC', 'optionC', 'Option C', 'option C', 'OPTION C', 'C']) || '',
                    optionD: getColumnValue(row, ['OptionD', 'optionD', 'Option D', 'option D', 'OPTION D', 'D']) || '',
                    correct: getColumnValue(row, ['Correct', 'correct', 'CORRECT', 'Answer', 'answer', 'ANSWER', 'Correct Answer']) || ''
                }));
                
                // Validate that we have questions with options
                const validQuestions = quizBank.filter(q => 
                    q.question && q.optionA && q.optionB && q.optionC && q.optionD && q.correct
                );
                
                if(validQuestions.length === 0) {
                    throw new Error('No valid questions found. Please ensure your Excel file has the correct column names.');
                }
                
                quizBank = validQuestions;
                
                // Initialize filteredBank with all questions
                filteredBank = [...quizBank];
                
                unsavedChanges = false;
                updateUnsavedIndicator();
                populateFilters();
                filterQuizBank();
                updateQuizFilters();
                
                statusDiv.innerHTML = '<div class="repo-status success">‚úÖ Successfully loaded ' + quizBank.length + ' questions from ' + selectedRepoFile.name + '!</div>';
                
                setTimeout(() => {
                    closeRepoModal();
                    switchTab('manage');
                }, 1500);
                
            } catch (error) {
                statusDiv.innerHTML = '<div class="repo-status error">‚ùå Error loading file: ' + error.message + '</div>';
                loadBtn.disabled = false;
                console.error('Error loading repo file:', error);
            }
        }

        window.onclick = function(event) {
            const repoModal = document.getElementById('repo-modal');
            if (event.target === repoModal) {
                closeRepoModal();
            }
        }

        function populateFilters() {
            const subjects = [...new Set(quizBank.map(q => q.subject))].filter(s => s);
            const tags = [...new Set(quizBank.flatMap(q => q.tags))].filter(t => t);
            
            document.getElementById('bank-subject-filter').innerHTML = '<option value="all">All Subjects</option>' + 
                subjects.map(s => `<option value="${s}">${s}</option>`).join('');
            
            document.getElementById('bank-tag-filter').innerHTML = '<option value="all">All Tags</option>' + 
                tags.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        function filterQuizBank() {
            const subject = document.getElementById('bank-subject-filter').value;
            const level = document.getElementById('bank-level-filter').value;
            const tag = document.getElementById('bank-tag-filter').value;
            const search = document.getElementById('bank-search').value.toLowerCase();
            
            filteredBank = quizBank.filter(q => {
                const subjectMatch = subject === 'all' || q.subject === subject;
                const levelMatch = level === 'all' || q.difficulty === level;
                const tagMatch = tag === 'all' || q.tags.includes(tag);
                const searchMatch = !search || q.question.toLowerCase().includes(search) || 
                                   q.optionA.toLowerCase().includes(search) ||
                                   q.optionB.toLowerCase().includes(search) ||
                                   q.optionC.toLowerCase().includes(search) ||
                                   q.optionD.toLowerCase().includes(search);
                return subjectMatch && levelMatch && tagMatch && searchMatch;
            });
            
            displayQuizBank();
        }

        function displayQuizBank() {
            const container = document.getElementById('quiz-bank-container');
            
            // Update count display
            document.getElementById('question-count-display').textContent = `(${filteredBank.length} / ${quizBank.length})`;
            
            if(filteredBank.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 40px;">No questions available. Upload a quiz bank to get started!</p>';
                return;
            }
            
            container.innerHTML = filteredBank.map((q, i) => {
                const originalIndex = quizBank.indexOf(q);
                return `
                    <div class="question-card">
                        <div class="question-card-header">${q.question}</div>
                        <div class="question-card-options">
                            <div class="question-card-option">A) ${q.optionA}</div>
                            <div class="question-card-option">B) ${q.optionB}</div>
                            <div class="question-card-option">C) ${q.optionC}</div>
                            <div class="question-card-option">D) ${q.optionD}</div>
                        </div>
                        <div class="question-card-meta">
                            <span class="meta-badge correct">‚úÖ ${q.correct}</span>
                            <span class="meta-badge subject">${q.subject}</span>
                            <span class="meta-badge difficulty ${q.difficulty.toLowerCase()}">${q.difficulty}</span>
                            ${q.tags.map(tag => `<span class="meta-badge tags">${tag}</span>`).join('')}
                        </div>
                        <div class="question-card-actions">
                            <button class="btn btn-warning" onclick="editQuestion(${originalIndex})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteQuestion(${originalIndex})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showAddQuestionModal() {
            document.getElementById('add-question-modal').classList.add('active');
        }

        function closeAddQuestionModal() {
            document.getElementById('add-question-modal').classList.remove('active');
            ['new-subject', 'new-difficulty', 'new-tags', 'new-question', 'new-option-a', 'new-option-b', 'new-option-c', 'new-option-d', 'new-correct'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }

        function saveNewQuestion() {
            const subject = document.getElementById('new-subject').value.trim();
            const difficulty = document.getElementById('new-difficulty').value;
            const tags = document.getElementById('new-tags').value.split(',').map(t => t.trim()).filter(t => t);
            const question = document.getElementById('new-question').value.trim();
            const optionA = document.getElementById('new-option-a').value.trim();
            const optionB = document.getElementById('new-option-b').value.trim();
            const optionC = document.getElementById('new-option-c').value.trim();
            const optionD = document.getElementById('new-option-d').value.trim();
            const correct = document.getElementById('new-correct').value;
            
            if(!subject || !difficulty || !question || !optionA || !optionB || !optionC || !optionD || !correct) {
                alert('‚ùå Please fill in all required fields!');
                return;
            }
            
            quizBank.push({subject, difficulty, tags, question, optionA, optionB, optionC, optionD, correct});
            unsavedChanges = true;
            updateUnsavedIndicator();
            populateFilters();
            filterQuizBank();
            updateQuizFilters();
            closeAddQuestionModal();
            alert('‚úÖ Question added successfully!');
        }

        function editQuestion(index) {
            const q = quizBank[index];
            document.getElementById('edit-index').value = index;
            document.getElementById('edit-subject').value = q.subject;
            document.getElementById('edit-difficulty').value = q.difficulty;
            document.getElementById('edit-tags').value = q.tags.join(', ');
            document.getElementById('edit-question').value = q.question;
            document.getElementById('edit-option-a').value = q.optionA;
            document.getElementById('edit-option-b').value = q.optionB;
            document.getElementById('edit-option-c').value = q.optionC;
            document.getElementById('edit-option-d').value = q.optionD;
            document.getElementById('edit-correct').value = q.correct;
            document.getElementById('edit-question-modal').classList.add('active');
        }

        function closeEditQuestionModal() {
            document.getElementById('edit-question-modal').classList.remove('active');
        }

        function saveEditedQuestion() {
            const index = parseInt(document.getElementById('edit-index').value);
            const subject = document.getElementById('edit-subject').value.trim();
            const difficulty = document.getElementById('edit-difficulty').value;
            const tags = document.getElementById('edit-tags').value.split(',').map(t => t.trim()).filter(t => t);
            const question = document.getElementById('edit-question').value.trim();
            const optionA = document.getElementById('edit-option-a').value.trim();
            const optionB = document.getElementById('edit-option-b').value.trim();
            const optionC = document.getElementById('edit-option-c').value.trim();
            const optionD = document.getElementById('edit-option-d').value.trim();
            const correct = document.getElementById('edit-correct').value;
            
            if(!subject || !difficulty || !question || !optionA || !optionB || !optionC || !optionD || !correct) {
                alert('‚ùå Please fill in all required fields!');
                return;
            }
            
            quizBank[index] = {subject, difficulty, tags, question, optionA, optionB, optionC, optionD, correct};
            unsavedChanges = true;
            updateUnsavedIndicator();
            populateFilters();
            filterQuizBank();
            updateQuizFilters();
            closeEditQuestionModal();
            alert('‚úÖ Question updated successfully!');
        }

        function deleteQuestion(index) {
            if(confirm('Are you sure you want to delete this question?')) {
                quizBank.splice(index, 1);
                unsavedChanges = true;
                updateUnsavedIndicator();
                populateFilters();
                filterQuizBank();
                updateQuizFilters();
            }
        }

        function updateUnsavedIndicator() {
            document.getElementById('unsaved-indicator').style.display = unsavedChanges ? 'inline-block' : 'none';
        }

        function downloadQuizBank() {
            if(quizBank.length === 0) {
                alert('‚ùå No questions to download!');
                return;
            }
            
            const ws = XLSX.utils.json_to_sheet(quizBank.map(q => ({
                Subject: q.subject,
                Difficulty: q.difficulty,
                Tags: q.tags.join(', '),
                Question: q.question,
                OptionA: q.optionA,
                OptionB: q.optionB,
                OptionC: q.optionC,
                OptionD: q.optionD,
                Correct: q.correct
            })));
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Questions');
            XLSX.writeFile(wb, 'quiz_bank_' + new Date().toISOString().split('T')[0] + '.xlsx');
            
            unsavedChanges = false;
            updateUnsavedIndicator();
            alert('‚úÖ Quiz bank downloaded successfully!');
        }

        function loadSampleData() {
            if(quizBank.length > 0 && !confirm('This will replace your current quiz bank. Continue?')) {
                return;
            }
            
            quizBank = [
                {subject: 'Mathematics', difficulty: 'Easy', tags: ['algebra', 'basics'], question: 'What is 2 + 2?', optionA: '3', optionB: '4', optionC: '5', optionD: '6', correct: 'B'},
                {subject: 'Science', difficulty: 'Medium', tags: ['physics', 'motion'], question: 'What is the SI unit of force?', optionA: 'Joule', optionB: 'Newton', optionC: 'Watt', optionD: 'Pascal', correct: 'B'},
                {subject: 'History', difficulty: 'Hard', tags: ['world war', 'dates'], question: 'When did World War II end?', optionA: '1943', optionB: '1944', optionC: '1945', optionD: '1946', correct: 'C'}
            ];
            
            // Initialize filteredBank with all questions
            filteredBank = [...quizBank];
            
            unsavedChanges = false;
            updateUnsavedIndicator();
            populateFilters();
            filterQuizBank();
            updateQuizFilters();
            alert('‚úÖ Sample data loaded successfully!');
        }

        function updateQuizFilters() {
            const subjects = [...new Set(quizBank.map(q => q.subject))].filter(s => s);
            const tags = [...new Set(quizBank.flatMap(q => q.tags))].filter(t => t);
            
            document.getElementById('subject-select').innerHTML = '<option value="all" selected>All Subjects</option>' + 
                subjects.map(s => `<option value="${s}">${s}</option>`).join('');
            
            document.getElementById('tag-select').innerHTML = '<option value="all" selected>All Tags</option>' + 
                tags.map(t => `<option value="${t}">${t}</option>`).join('');
            
            // Update total questions count
            updateAvailableQuestionsCount();
        }

        function updateAvailableQuestionsCount() {
            const selectedSubjects = Array.from(document.getElementById('subject-select').selectedOptions).map(o => o.value);
            const selectedLevels = Array.from(document.getElementById('level-select').selectedOptions).map(o => o.value);
            const selectedTags = Array.from(document.getElementById('tag-select').selectedOptions).map(o => o.value);
            
            let filteredCount = quizBank.filter(q => {
                const subjectMatch = selectedSubjects.includes('all') || selectedSubjects.includes(q.subject);
                const levelMatch = selectedLevels.includes('all') || selectedLevels.includes(q.difficulty);
                const tagMatch = selectedTags.includes('all') || selectedTags.length === 0 || selectedTags.some(tag => q.tags.includes(tag));
                return subjectMatch && levelMatch && tagMatch;
            }).length;
            
            document.getElementById('total-questions-count').textContent = `${filteredCount} / ${quizBank.length}`;
        }

        function startQuiz() {
            if(quizBank.length === 0) {
                alert('‚ùå Please upload a quiz bank first!');
                return;
            }
            
            // Clear any existing timer
            if(timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            const selectedSubjects = Array.from(document.getElementById('subject-select').selectedOptions).map(o => o.value);
            const selectedLevels = Array.from(document.getElementById('level-select').selectedOptions).map(o => o.value);
            const selectedTags = Array.from(document.getElementById('tag-select').selectedOptions).map(o => o.value);
            const questionCount = parseInt(document.getElementById('question-count').value);
            const timeLimit = parseInt(document.getElementById('time-limit').value);
            quizMode = document.getElementById('quiz-mode').value;
            
            if(selectedSubjects.length === 0) {
                alert('‚ùå Please select at least one subject!');
                return;
            }
            
            let availableQuestions = quizBank.filter(q => {
                const subjectMatch = selectedSubjects.includes('all') || selectedSubjects.includes(q.subject);
                const levelMatch = selectedLevels.includes('all') || selectedLevels.includes(q.difficulty);
                const tagMatch = selectedTags.includes('all') || selectedTags.length === 0 || selectedTags.some(tag => q.tags.includes(tag));
                return subjectMatch && levelMatch && tagMatch;
            });
            
            if(availableQuestions.length === 0) {
                alert('‚ùå No questions match your selected criteria!');
                return;
            }
            
            // Randomize questions
            availableQuestions = availableQuestions.sort(() => Math.random() - 0.5);
            currentQuiz = availableQuestions.slice(0, Math.min(questionCount, availableQuestions.length));
            
            // Always shuffle answer options
            currentQuiz = currentQuiz.map(q => {
                const options = [
                    {label: 'A', text: q.optionA, isCorrect: q.correct === 'A'},
                    {label: 'B', text: q.optionB, isCorrect: q.correct === 'B'},
                    {label: 'C', text: q.optionC, isCorrect: q.correct === 'C'},
                    {label: 'D', text: q.optionD, isCorrect: q.correct === 'D'}
                ].sort(() => Math.random() - 0.5);
                
                const newCorrect = options.findIndex(o => o.isCorrect);
                return {...q, optionA: options[0].text, optionB: options[1].text, optionC: options[2].text, optionD: options[3].text, correct: String.fromCharCode(65 + newCorrect)};
            });
            
            userAnswers = {};
            document.getElementById('quiz-container').style.display = 'block';
            document.querySelector('.start-quiz-btn').style.display = 'none';
            document.querySelector('#quiz-tab h2').style.display = 'none';
            document.querySelector('.quiz-settings-grid').style.display = 'none';
            
            // Hide total questions info during quiz
            const totalQuestionsInfo = document.getElementById('total-questions-info');
            if (totalQuestionsInfo) {
                totalQuestionsInfo.style.display = 'none';
            }
            
            renderQuiz();
            
            if(timeLimit > 0) {
                startTimer(timeLimit);
            }
        }

        function renderQuiz() {
            const container = document.getElementById('quiz-questions');
            container.innerHTML = '';
            
            if(quizMode === 'one') {
                // One question at a time mode
                const q = currentQuiz[currentQuestionIndex];
                container.innerHTML = `
                    <div class="quiz-question">
                        <span class="question-number">Question ${currentQuestionIndex + 1} of ${currentQuiz.length}</span>
                        <h3>${q.question}</h3>
                        <div class="options">
                            <div class="option-wrapper">
                                <input type="radio" name="q${currentQuestionIndex}" id="q${currentQuestionIndex}a" value="A" ${userAnswers[currentQuestionIndex] === 'A' ? 'checked' : ''} onchange="saveAnswer(${currentQuestionIndex}, 'A')">
                                <label for="q${currentQuestionIndex}a" class="option-label">A) ${q.optionA}</label>
                            </div>
                            <div class="option-wrapper">
                                <input type="radio" name="q${currentQuestionIndex}" id="q${currentQuestionIndex}b" value="B" ${userAnswers[currentQuestionIndex] === 'B' ? 'checked' : ''} onchange="saveAnswer(${currentQuestionIndex}, 'B')">
                                <label for="q${currentQuestionIndex}b" class="option-label">B) ${q.optionB}</label>
                            </div>
                            <div class="option-wrapper">
                                <input type="radio" name="q${currentQuestionIndex}" id="q${currentQuestionIndex}c" value="C" ${userAnswers[currentQuestionIndex] === 'C' ? 'checked' : ''} onchange="saveAnswer(${currentQuestionIndex}, 'C')">
                                <label for="q${currentQuestionIndex}c" class="option-label">C) ${q.optionC}</label>
                            </div>
                            <div class="option-wrapper">
                                <input type="radio" name="q${currentQuestionIndex}" id="q${currentQuestionIndex}d" value="D" ${userAnswers[currentQuestionIndex] === 'D' ? 'checked' : ''} onchange="saveAnswer(${currentQuestionIndex}, 'D')">
                                <label for="q${currentQuestionIndex}d" class="option-label">D) ${q.optionD}</label>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 20px; padding: 20px;">
                        ${currentQuestionIndex > 0 ? '<button class="btn btn-primary" onclick="navigateQuestion(-1)">‚¨ÖÔ∏è Previous</button>' : '<div></div>'}
                        <div style="font-size: 1.1em; font-weight: 700; color: #233c86; align-self: center;">Question ${currentQuestionIndex + 1} of ${currentQuiz.length}</div>
                        ${currentQuestionIndex < currentQuiz.length - 1 ? '<button class="btn btn-primary" onclick="navigateQuestion(1)">Next ‚û°Ô∏è</button>' : '<div></div>'}
                    </div>
                `;
            } else {
                // All questions at once mode
                container.innerHTML = currentQuiz.map((q, i) => `
                    <div class="quiz-question" id="question-${i}">
                        <span class="question-number">Question ${i + 1} of ${currentQuiz.length}</span>
                        <h3>${q.question}</h3>
                        <div class="options">
                            <div class="option-wrapper">
                                <input type="radio" name="q${i}" id="q${i}a" value="A" ${userAnswers[i] === 'A' ? 'checked' : ''} onchange="saveAnswer(${i}, 'A')">
                                <label for="q${i}a" class="option-label">A) ${q.optionA}</label>
                            </div>
                            <div class="option-wrapper">
                                <input type="radio" name="q${i}" id="q${i}b" value="B" ${userAnswers[i] === 'B' ? 'checked' : ''} onchange="saveAnswer(${i}, 'B')">
                                <label for="q${i}b" class="option-label">B) ${q.optionB}</label>
                            </div>
                            <div class="option-wrapper">
                                <input type="radio" name="q${i}" id="q${i}c" value="C" ${userAnswers[i] === 'C' ? 'checked' : ''} onchange="saveAnswer(${i}, 'C')">
                                <label for="q${i}c" class="option-label">C) ${q.optionC}</label>
                            </div>
                            <div class="option-wrapper">
                                <input type="radio" name="q${i}" id="q${i}d" value="D" ${userAnswers[i] === 'D' ? 'checked' : ''} onchange="saveAnswer(${i}, 'D')">
                                <label for="q${i}d" class="option-label">D) ${q.optionD}</label>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function navigateQuestion(direction) {
            currentQuestionIndex += direction;
            currentQuestionIndex = Math.max(0, Math.min(currentQuestionIndex, currentQuiz.length - 1));
            renderQuiz();
            document.getElementById('quiz-questions').scrollIntoView({behavior: 'smooth', block: 'start'});
        }

        function saveAnswer(questionIndex, answer) {
            userAnswers[questionIndex] = answer;
            
            if(quizMode === 'one') {
                // Auto-advance to next question in one-at-a-time mode
                if(questionIndex < currentQuiz.length - 1) {
                    setTimeout(() => {
                        currentQuestionIndex++;
                        renderQuiz();
                        document.getElementById('quiz-questions').scrollIntoView({behavior: 'smooth', block: 'start'});
                    }, 500);
                }
            } else if(quizMode === 'all') {
                // Scroll to next question in all-at-once mode
                const nextQuestionIndex = questionIndex + 1;
                if(nextQuestionIndex < currentQuiz.length) {
                    setTimeout(() => {
                        const nextQuestion = document.getElementById(`question-${nextQuestionIndex}`);
                        if(nextQuestion) nextQuestion.scrollIntoView({behavior: 'smooth', block: 'center'});
                    }, 300);
                }
            }
        }

        function startTimer(minutes) {
            let timeLeft = minutes * 60;
            const timerElement = document.getElementById('timer');
            timerElement.style.display = 'flex';
            
            timerInterval = setInterval(() => {
                const mins = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                timerElement.textContent = `‚è±Ô∏è ${mins}:${secs.toString().padStart(2, '0')}`;
                
                timerElement.classList.remove('warning', 'danger');
                if(timeLeft <= 60) {
                    timerElement.classList.add('danger');
                } else if(timeLeft <= 180) {
                    timerElement.classList.add('warning');
                }
                
                timeLeft--;
                
                if(timeLeft < 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    submitQuiz();
                }
            }, 1000);
        }

        function submitQuiz() {
            if(timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            let correctCount = 0;
            const results = currentQuiz.map((q, i) => {
                const userAnswer = userAnswers[i] || 'Not answered';
                const isCorrect = userAnswer === q.correct;
                if(isCorrect) correctCount++;
                
                return {
                    question: q.question,
                    userAnswer: userAnswer,
                    correctAnswer: q.correct,
                    isCorrect: isCorrect,
                    optionA: q.optionA,
                    optionB: q.optionB,
                    optionC: q.optionC,
                    optionD: q.optionD
                };
            });
            
            displayResults(results, correctCount);
        }

        function displayResults(results, correctCount) {
            const totalQuestions = results.length;
            const percentage = Math.round((correctCount / totalQuestions) * 100);
            
            let emoji, message;
            if(percentage >= 90) {
                emoji = 'üèÜ';
                message = 'Outstanding! You\'re a Quiz Champion!';
            } else if(percentage >= 75) {
                emoji = '‚≠ê';
                message = 'Excellent Work! Great Performance!';
            } else if(percentage >= 60) {
                emoji = 'üëç';
                message = 'Good Job! Keep it up!';
            } else if(percentage >= 50) {
                emoji = 'üìö';
                message = 'Not bad! Keep practicing!';
            } else {
                emoji = 'üí™';
                message = 'Keep learning! You\'ll improve!';
            }
            
            let html = `
                <div class="results-section">
                    <div class="performance-emoji">${emoji}</div>
                    <h2 class="performance-message">${message}</h2>
                    <div class="quiz-stats">
                        <div class="stat-card">
                            <div class="stat-value">${correctCount}</div>
                            <div class="stat-label">Correct</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${totalQuestions - correctCount}</div>
                            <div class="stat-label">Incorrect</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${totalQuestions}</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${percentage}%</div>
                            <div class="stat-label">Score</div>
                        </div>
                    </div>
                </div>
                <h3 style="color: #233c86; margin: 20px 0;">Detailed Results</h3>
            `;
            
            results.forEach((r, i) => {
                html += `
                    <div class="result-item ${r.isCorrect ? 'correct' : 'incorrect'}">
                        <h4 style="color: #233c86; margin-bottom: 10px;">Question ${i + 1}: ${r.question}</h4>
                        <p style="margin: 5px 0;">Your answer: <span class="${r.isCorrect ? 'correct-answer' : 'incorrect-answer'}">${r.userAnswer}</span></p>
                        <p style="margin: 5px 0;">Correct answer: <span class="correct-answer">${r.correctAnswer}</span></p>
                        ${r.isCorrect ? 
                            '<p style="color: #27ae60; font-weight: 600; margin-top: 5px;">‚úÖ Correct!</p>' : 
                            '<p style="color: #e74c3c; font-weight: 600; margin-top: 5px;">‚ùå Incorrect</p>'}
                    </div>
                `;
            });
            
            html += '<button class="btn btn-primary" onclick="resetQuiz()" style="width: 100%; margin-top: 20px;">Take Another Quiz</button>';
            
            document.getElementById('results-container').innerHTML = html;
            switchTab('results');
        }

        function resetQuiz() {
            // Clear quiz data
            currentQuiz = [];
            userAnswers = {};
            currentQuestionIndex = 0;
            
            // Clear timer
            if(timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // Reset and hide quiz container
            document.getElementById('quiz-container').style.display = 'none';
            document.getElementById('timer').style.display = 'none';
            document.getElementById('timer').classList.remove('warning', 'danger');
            document.getElementById('quiz-questions').innerHTML = '';
            
            // Show quiz configuration elements
            document.querySelector('.start-quiz-btn').style.display = 'block';
            const quizHeader = document.querySelector('#quiz-tab h2');
            if(quizHeader) quizHeader.style.display = 'block';
            document.querySelector('.quiz-settings-grid').style.display = 'grid';
            
            // Show total questions info
            const totalQuestionsInfo = document.getElementById('total-questions-info');
            if (totalQuestionsInfo) {
                totalQuestionsInfo.style.display = 'block';
            }
            
            // DO NOT reset filters - keep the same selections
            // Users can change them if they want before starting new quiz
            
            // Switch to quiz tab
            switchTab('quiz');
            
            // Scroll to top
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        window.addEventListener('beforeunload', function(e) {
            if(unsavedChanges || currentQuiz.length > 0) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        window.addEventListener('load', function() {
            loadSampleData();
        });
    </script>
</body>
</html>
